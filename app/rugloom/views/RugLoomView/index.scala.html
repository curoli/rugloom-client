@(title: String)

<html>
    <head>
        <title>@title</title>
        <style>
        body {
        background-color : black ;
        color : yellow ;
        font-family : sans-serif ;
        }
        pre {
        font-family : Lucida Console, Lucida Sans Typewriter, monaco, Bitstream Vera Sans Mono, monospace ;
        }
        .lineEntered {
        color : lightgreen ;
        }
        .consoleOut {
        color : lightblue ;
        }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
        <script>
            var socket;
            var enteredLineNum = 0;
            var LARGE_INTEGER = 2e9;
            var consoleEntries = [];
            function createMessageId() {
                return { time: Date.now(), rand: Math.round(2*LARGE_INTEGER*Math.random() - LARGE_INTEGER) };
            }
            function createPingMessage() {
                var id = createMessageId();
                return { id: id, kind: "ping" };
            }
            function createEchoMessage(pingMessage) {
                var id = createMessageId();
                return { id: id, kind: "echo", inResponseToId: pingMessage.id, inResponseToKind: pingMessage.kind };
            }
            function createLineEnteredMessage(line, num) {
                var id = createMessageId();
                return { id: id, kind: "lineEntered", line: line, num: num};
            }
            function sendPing() {
                socket.send(JSON.stringify(createPingMessage()));
            }
            function processMessage(msg) {
                if(msg.kind == "ping") {
                    console.log("I have received a ping message.\n Time stamp: " + new Date(msg.id.time));
                    socket.send(JSON.stringify(createEchoMessage(msg)))
                } else if(msg.kind == "echo") {
                    console.log("I have received an echo message.\n Time stamp: " + new Date(msg.id.time));
                } else if(msg.kind == "shellResponse") {
                    console.log("I have received a shell response message.\n Time stamp: " +
                        new Date(msg.id.time));
                    var entry = consoleEntries[msg.num];
                    entry.line = msg.line;
                    entry.resultReturned = msg.resultReturned;
                    entry.consoleOut = msg.consoleOut;
                    showConsoleEntries();
                } else {
                    console.log("I have received a message I did not understand:\n" + JSON.stringify(msg, null, 2))
                }
            }
            function openSocket() {
                socket = new WebSocket("ws://localhost:9000/socket");
                socket.onopen = function() { sendPing() } ;
                socket.onmessage = function(event) { processMessage(JSON.parse(event.data)); };
            }
            function addConsoleEntry(line) {
                var entry = { line: line };
                return consoleEntries.push(entry) - 1;
            }
            function consoleEntryId(num) { return "rugLoomConsoleEntry" + num; }
            function showConsoleEntries() {
                var entryDivs = d3.select("#rugLoomConsole").selectAll("div.consoleEntry").data(consoleEntries);
                var newDivs = entryDivs.enter().append("div").attr("class", "consoleEntry")
                .attr("id", function(d, i) { return consoleEntryId(i); });
                newDivs.append("div").attr("class", "lineEntered").append("pre");
                newDivs.append("div").attr("class", "consoleOut").append("pre");
                entryDivs.select(".lineEntered").select("pre").text(function(d) { return d.line; });
                entryDivs.select(".consoleOut").select("pre").text(function(d) { return d.consoleOut; });
            }
            function onCommandKeyPress(event) {
                var keyCode = event.keyCode || event.which;
                if(keyCode == 13) {
                    var commandInput = d3.select("#commandInput");
                    var lineEntered = commandInput.property("value");
                    console.log("Line entered: " + lineEntered);
                    var enteredLineNum = addConsoleEntry(lineEntered);
                    showConsoleEntries();
                    var message = createLineEnteredMessage(lineEntered, enteredLineNum);
                    socket.send(JSON.stringify(message));
                    commandInput.property("value", "");
                }
            }
        </script>
    </head>
    <body onload="openSocket()">
        <h1>@title</h1>
        <p>Hello, this is @title! Enter an expression.</p>
        <div id="rugLoomConsole"></div>
        <input id="commandInput" type="text" size="100" onkeypress="onCommandKeyPress(event);"/>
    </body>
</html>